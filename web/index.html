<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Bounty Bot - Live Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace; 
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); 
            color: #e0e0e0; 
            padding: 15px;
            min-height: 100vh;
            font-size: 11px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        
        h1 { 
            text-align: center; 
            margin-bottom: 15px; 
            color: #00ff88; 
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            font-size: 1.3em;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .dashboard { display: grid; grid-template-columns: 280px 1fr; gap: 15px; height: calc(100vh - 80px); }
        .left-panel { display: flex; flex-direction: column; gap: 12px; }
        
        .card { 
            background: rgba(26, 31, 58, 0.8); 
            backdrop-filter: blur(10px);
            padding: 14px; 
            border-radius: 8px; 
            border: 1px solid rgba(0, 255, 136, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .card h2 { 
            color: #00d4ff; 
            margin-bottom: 10px; 
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .stat { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            align-items: center;
        }
        .stat:last-child { border-bottom: none; }
        .stat-label { color: #888; font-size: 0.9em; }
        .stat-value { color: #00ff88; font-weight: 600; font-size: 0.9em; }
        
        .quick-stat { 
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 255, 136, 0.1) 100%);
            padding: 12px; 
            margin-bottom: 10px; 
            border-radius: 6px; 
            text-align: center;
            border: 1px solid rgba(0, 255, 136, 0.15);
        }
        .quick-stat:last-child { margin-bottom: 0; }
        .quick-stat-value { 
            font-size: 1.8em; 
            color: #00ff88; 
            font-weight: 700; 
            display: block; 
            margin-bottom: 3px;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        .quick-stat-label { color: #aaa; font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.3px; }
        
        .entries { 
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            padding: 14px; 
            border-radius: 8px; 
            border: 1px solid rgba(0, 255, 136, 0.2);
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .entries h2 { 
            margin-bottom: 12px; 
            color: #00d4ff; 
            font-size: 0.85em;
            position: sticky; 
            top: 0; 
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 0; 
            z-index: 10;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .entry { 
            background: rgba(15, 20, 37, 0.6);
            padding: 10px; 
            margin-bottom: 8px; 
            border-radius: 6px; 
            border-left: 2px solid #00ff88;
            transition: all 0.2s ease;
        }
        .entry:hover { 
            background: rgba(21, 26, 48, 0.8);
            border-left-color: #00d4ff;
            transform: translateX(2px);
        }
        
        .entry-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 6px; 
            align-items: center;
        }
        .entry-action { 
            color: #00d4ff; 
            font-weight: 600; 
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.2px;
        }
        .entry-time { color: #666; font-size: 0.75em; }
        .entry-details { 
            color: #bbb; 
            line-height: 1.5; 
            white-space: pre-wrap; 
            font-size: 0.85em;
            font-family: 'Courier New', monospace;
        }
        
        .bounty-id { 
            display: inline-block;
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 6px;
            font-weight: 600;
        }
        
        .live-indicator { 
            display: inline-block; 
            width: 6px; 
            height: 6px; 
            background: #00ff88; 
            border-radius: 50%; 
            animation: pulse 2s infinite; 
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.4; transform: scale(0.9); } 
        }
        
        .connected { color: #00ff88; }
        .disconnected { color: #ff4444; }
        
        .entries::-webkit-scrollbar { width: 6px; }
        .entries::-webkit-scrollbar-track { background: rgba(15, 20, 37, 0.5); border-radius: 3px; }
        .entries::-webkit-scrollbar-thumb { background: rgba(0, 255, 136, 0.3); border-radius: 3px; }
        .entries::-webkit-scrollbar-thumb:hover { background: rgba(0, 255, 136, 0.5); }
        
        @media (max-width: 1200px) {
            .dashboard { grid-template-columns: 1fr; height: auto; }
            .entries { height: 600px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ¤– AUTONOMOUS BOUNTY BOT - LIVE DASHBOARD</h1>
        
        <div class="dashboard">
            <div class="left-panel">
                <div class="card">
                    <h2><span class="live-indicator"></span>System Status</h2>
                    <div class="stat">
                        <span class="stat-label">Connection</span>
                        <span class="stat-value" id="connection-status">Connecting...</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Last Update</span>
                        <span class="stat-value" id="last-update">Never</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Total Entries</span>
                        <span class="stat-value" id="total-entries">0</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Chain Information</h2>
                    <div class="stat">
                        <span class="stat-label">Chain Name</span>
                        <span class="stat-value" id="chain-name">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Chain ID</span>
                        <span class="stat-value" id="chain-id">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Contract Address</span>
                        <span class="stat-value" id="contract-address">-</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Activity Summary</h2>
                    <div class="quick-stat">
                        <span class="quick-stat-value" id="bounties-created">0</span>
                        <span class="quick-stat-label">Bounties Created</span>
                    </div>
                    <div class="quick-stat">
                        <span class="quick-stat-value" id="submissions-validated">0</span>
                        <span class="quick-stat-label">Submissions Validated</span>
                    </div>
                    <div class="quick-stat">
                        <span class="quick-stat-value" id="winners-paid">0</span>
                        <span class="quick-stat-label">Winners Paid</span>
                    </div>
                </div>
            </div>

            <div class="entries">
                <h2>Audit Trail (Live)</h2>
                <div id="entries-container">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        Waiting for audit trail data...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource;
        
        function connect() {
            eventSource = new EventSource('/api/stream');
            
            eventSource.onopen = () => {
                document.getElementById('connection-status').textContent = 'Connected';
                document.getElementById('connection-status').className = 'stat-value connected';
            };
            
            eventSource.onerror = () => {
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').className = 'stat-value disconnected';
                setTimeout(connect, 5000);
            };
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'INIT' || data.type === 'UPDATE') {
                    updateDashboard(data.state || data.data);
                }
            };
        }
        
        function updateDashboard(data) {
            if (!data.state && !data.summary) return;
            
            // Update stats
            document.getElementById('total-entries').textContent = data.state?.totalEntries || data.summary?.totalEntries || 0;
            document.getElementById('bounties-created').textContent = data.summary?.totalBountiesCreated || 0;
            document.getElementById('submissions-validated').textContent = data.summary?.submissionsValidated || 0;
            document.getElementById('winners-paid').textContent = data.summary?.winnersPaid || 0;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            
            document.getElementById('chain-id').textContent = data.state?.chainId || '-';
            if (data.state?.chainId) {
                const agentStartedEntry = data.state?.entries?.find(e => e.action === 'AGENT_STARTED');
                if (agentStartedEntry) {
                    document.getElementById('chain-name').textContent = agentStartedEntry.details?.network || '-';
                }
            }
            document.getElementById('contract-address').textContent = data.state?.contractAddress || '-';
            
            // Update entries
            if (data.state && data.state.entries && data.state.entries.length > 0) {
                const container = document.getElementById('entries-container');
                container.innerHTML = '';
                
                // Show last 30 entries in reverse order (newest first)
                const entries = data.state.entries.slice(-30).reverse();
                
                entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'entry';
                    
                    const time = new Date(entry.timestamp).toLocaleString();
                    const details = formatDetails(entry.details, entry.action);
                    
                    // Extract bounty ID if present
                    let bountyIdBadge = '';
                    if (entry.details && entry.details.bountyId) {
                        bountyIdBadge = `<span class="bounty-id">#${entry.details.bountyId}</span>`;
                    } else if (entry.details && entry.details.onChainId) {
                        bountyIdBadge = `<span class="bounty-id">#${entry.details.onChainId}</span>`;
                    } else if (entry.details && typeof entry.details === 'string' && entry.details.includes('On-Chain ID:')) {
                        const match = entry.details.match(/On-Chain ID:\s*(\d+)/);
                        if (match) {
                            bountyIdBadge = `<span class="bounty-id">#${match[1]}</span>`;
                        }
                    }
                    
                    entryDiv.innerHTML = `
                        <div class="entry-header">
                            <span class="entry-action">${entry.action}${bountyIdBadge}</span>
                            <span class="entry-time">${time}</span>
                        </div>
                        <div class="entry-details">${details}</div>
                    `;
                    
                    container.appendChild(entryDiv);
                });
            }
        }
        
        function formatDetails(details, action) {
            if (typeof details === 'string') return details;
            if (typeof details === 'object' && details !== null) {
                let formatted = '';
                switch (action) {
                    case 'BOUNTY_CREATED':
                        formatted += `Name: ${details.name}\n`;
                        formatted += `Reward: ${details.rewardAmount || details.rewardEth} ${details.rewardCurrency || 'ETH'}\n`;
                        formatted += `Chain: ${details.chainName || 'Unknown'}\n`;
                        if(details.onChainId) formatted += `On-Chain ID: ${details.onChainId}\n`;
                        break;
                    case 'BOUNTIES_AUTO_INDEXED':
                        formatted += `â”Œâ”€ BOUNTY AUTO-INDEXING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        formatted += `â”‚ Bot Wallet: ${details.botWalletAddress}\n`;
                        formatted += `â”‚ Chain: ${details.chainName} (ID: ${details.chainId})\n`;
                        formatted += `â”‚ Native Currency: ${details.nativeCurrency}\n`;
                        formatted += `â”‚ Bounties Scanned: ${details.totalBountiesScanned}\n`;
                        formatted += `â”‚ Bot Bounties Found: ${details.botBountiesFound}\n`;
                        formatted += `â”‚\n`;
                        formatted += `â”‚ FILTER CRITERIA:\n`;
                        formatted += `â”‚   ${details.filterCriteria}\n`;
                        formatted += `â”‚\n`;
                        formatted += `â”‚ VERIFICATION LOGIC:\n`;
                        if (details.verificationLogic) {
                            details.verificationLogic.forEach(step => {
                                formatted += `â”‚   ${step}\n`;
                            });
                        }
                        if (details.discoveredBounties && details.discoveredBounties.length > 0) {
                            formatted += `â”‚\n`;
                            formatted += `â”‚ DISCOVERED BOUNTIES:\n`;
                            details.discoveredBounties.forEach(bounty => {
                                formatted += `â”‚   #${bounty.id}: ${bounty.name}\n`;
                                formatted += `â”‚      Reward: ${bounty.rewardAmount} ${bounty.rewardCurrency}\n`;
                            });
                        }
                        formatted += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        break;
                    case 'SUBMISSION_VALIDATED':
                        formatted += `â”Œâ”€ SUBMISSION VALIDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        formatted += `â”‚ Bounty ID: ${details.bountyId}\n`;
                        formatted += `â”‚ Submitter: ${details.submitter}\n`;
                        formatted += `â”‚ Claim ID: ${details.claimId}\n`;
                        formatted += `â”‚ Status: ${details.isValid ? 'âœ“ VALID' : 'âœ— INVALID'}\n`;
                        formatted += `â”‚ Score: ${details.validationScore}/100 (Threshold: ${details.passingThreshold || 50})\n`;
                        if (details.aiScore !== undefined) {
                            formatted += `â”‚ AI Score: ${details.aiScore}/100\n`;
                            formatted += `â”‚ AI Confidence: ${(details.aiConfidence * 100).toFixed(0)}%\n`;
                        }
                        formatted += `â”‚\n`;
                        formatted += `â”‚ VALIDATION CHECKS:\n`;
                        if (details.validationChecks && details.validationChecks.length > 0) {
                            details.validationChecks.forEach(check => {
                                formatted += `â”‚   ${check.passed ? 'âœ“' : 'âœ—'} ${check.checkName || check.name}: ${check.details || check.reasoning}\n`;
                            });
                        } else if (details.checks) {
                            details.checks.forEach(check => {
                                formatted += `â”‚   ${check.passed ? 'âœ“' : 'âœ—'} ${check.name}: ${check.details}\n`;
                            });
                        }
                        if (details.decisionReason) {
                            formatted += `â”‚\n`;
                            formatted += `â”‚ DECISION: ${details.decisionReason}\n`;
                        }
                        if (details.aiReasoning) {
                            formatted += `â”‚\n`;
                            formatted += `â”‚ AI REASONING: ${details.aiReasoning.substring(0, 200)}...\n`;
                        }
                        formatted += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        break;
                    case 'SUBMISSION_REJECTED':
                        formatted += `â”Œâ”€ SUBMISSION REJECTED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        formatted += `â”‚ Bounty ID: ${details.bountyId}\n`;
                        formatted += `â”‚ Submitter: ${details.submitter}\n`;
                        formatted += `â”‚ Claim ID: ${details.claimId}\n`;
                        formatted += `â”‚ Validation Score: ${details.validationScore || 'N/A'}/100\n`;
                        formatted += `â”‚\n`;
                        formatted += `â”‚ REJECTION REASON:\n`;
                        formatted += `â”‚   ${details.reason}\n`;
                        if (details.failedChecks && details.failedChecks.length > 0) {
                            formatted += `â”‚\n`;
                            formatted += `â”‚ FAILED CHECKS (Why Rejected):\n`;
                            details.failedChecks.forEach(check => {
                                formatted += `â”‚   âœ— ${check.name}: ${check.details}\n`;
                            });
                        }
                        if (details.passedChecks && details.passedChecks.length > 0) {
                            formatted += `â”‚\n`;
                            formatted += `â”‚ PASSED CHECKS:\n`;
                            details.passedChecks.forEach(check => {
                                formatted += `â”‚   âœ“ ${check.name}: ${check.details}\n`;
                            });
                        }
                        formatted += `â”‚\n`;
                        formatted += `â”‚ VERIFICATION METHOD:\n`;
                        formatted += `â”‚   Validation engine evaluated submission against bounty criteria.\n`;
                        formatted += `â”‚   Score did not meet minimum threshold of 50/100.\n`;
                        formatted += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        break;
                    case 'WINNER_RATIONALE':
                        formatted += `â”Œâ”€ WINNER SELECTION RATIONALE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        formatted += `â”‚ Bounty: ${details.bountyName} (${details.bountyId})\n`;
                        formatted += `â”‚ Selection Mode: ${details.selectionMode === 'first_valid' ? 'First Valid Submission' : 'AI Judged'}\n`;
                        formatted += `â”‚ Winner: ${details.winner?.address || 'Unknown'}\n`;
                        formatted += `â”‚ Claim ID: ${details.winner?.claimId || 'Unknown'}\n`;
                        formatted += `â”‚ Competitors: ${details.competitorCount || 0}\n`;
                        formatted += `â”‚\n`;
                        formatted += `â”‚ VALIDATION CHECKS:\n`;
                        if (details.validationChecks) {
                            details.validationChecks.forEach(check => {
                                formatted += `â”‚   ${check.passed ? 'âœ“' : 'âœ—'} ${check.name}: ${check.details}\n`;
                            });
                        }
                        if (details.aiEvaluation) {
                            formatted += `â”‚\n`;
                            formatted += `â”‚ AI EVALUATION (${details.aiEvaluation.model || 'GPT-4'}):\n`;
                            formatted += `â”‚   Score: ${details.aiEvaluation.score}/100\n`;
                            formatted += `â”‚   Confidence: ${(details.aiEvaluation.confidence * 100).toFixed(0)}%\n`;
                            formatted += `â”‚   Reasoning: ${details.aiEvaluation.reasoning?.substring(0, 150) || 'N/A'}...\n`;
                        }
                        if (details.competitorsSummary && details.competitorsSummary.length > 0) {
                            formatted += `â”‚\n`;
                            formatted += `â”‚ OTHER SUBMISSIONS:\n`;
                            details.competitorsSummary.slice(0, 5).forEach(comp => {
                                formatted += `â”‚   ${comp.address.slice(0, 10)}... - ${comp.status}${comp.score ? ` (score: ${comp.score})` : ''}${comp.reason ? ` - ${comp.reason}` : ''}\n`;
                            });
                        }
                        formatted += `â”‚\n`;
                        formatted += `â”‚ FINAL DECISION:\n`;
                        formatted += `â”‚   ${details.decisionSummary}\n`;
                        formatted += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        break;
                    case 'PAYOUT_CONFIRMED':
                        formatted += `â”Œâ”€ PAYOUT CONFIRMED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        formatted += `â”‚ Bounty: ${details.bountyName || details.bountyId}\n`;
                        formatted += `â”‚ Winner: ${details.winner}\n`;
                        formatted += `â”‚ Reward: ${details.rewardAmount || details.rewardEth} ${details.rewardCurrency || 'ETH'}\n`;
                        formatted += `â”‚ Chain: ${details.chainName || 'Unknown'}\n`;
                        formatted += `â”‚ TX Hash: ${details.transactionHash}\n`;
                        formatted += `â”‚\n`;
                        formatted += `â”‚ VALIDATION SUMMARY:\n`;
                        formatted += `â”‚   Score: ${details.validationScore || 'N/A'}/100\n`;
                        if (details.aiScore) {
                            formatted += `â”‚   AI Score: ${details.aiScore}/100\n`;
                        }
                        formatted += `â”‚   Selection Mode: ${details.selectionMode || 'Unknown'}\n`;
                        formatted += `â”‚\n`;
                        formatted += `â”‚ STATUS: ${details.status || 'completed'}\n`;
                        formatted += `â”‚ ${details.finalStep || 'Payment released to winner on-chain'}\n`;
                        formatted += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                        break;
                    default:
                        for (const [key, value] of Object.entries(details)) {
                            if (typeof value !== 'object') {
                                formatted += `${key}: ${value}\n`;
                            }
                        }
                }
                return formatted.trim() || JSON.stringify(details, null, 2);
            }
            return String(details);
        }
        
        // Initial load
        fetch('/api/audit-state')
            .then(res => res.json())
            .then(data => updateDashboard(data))
            .catch(err => console.error('Failed to load initial state:', err));
        
        // Connect to live stream
        connect();
        
        // Refresh every 5 seconds as backup
        setInterval(() => {
            fetch('/api/audit-state')
                .then(res => res.json())
                .then(data => updateDashboard(data))
                .catch(err => console.error('Failed to refresh:', err));
        }, 5000);
    </script>
</body>
</html>
